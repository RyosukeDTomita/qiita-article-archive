---
title: 【教養】3分でわかるSQLのN+1問題
tags:
  - SQL
  - RDS
  - n+1問題
private: false
updated_at: '2024-07-17T11:18:39+09:00'
id: c27b5b9ec5f26126f0a7
organization_url_name: null
slide: false
ignorePublish: false
---
## なぜ必要か
- データを効率的に管理する方法としてSQLがある。
- SQLサーバへの負荷を最小にしたい --> クラウドサービスならコストも安くなるし単純に動作も早くなるため。

---

## SQLのN+1問題とは

### SNSを例に

タイムラインに表示する投稿を集めるスクリプトを作る必要があるとする。
この際以下のようなテーブルになっているとする。

|id|投稿内容|ユーザID|
|--|-------|-------|
|1 |わわわ  |1      |
|2 |なんとかなれー   |2      |
|3 |ふ   |1      |


|ユーザID|ユーザ名|
|--------|--------|
|1       |ちいかわ|
|2       |ハチワレ|

そして，タイムラインに`ユーザ名`と`投稿内容`をセットにして表示したい!という要件を満たす必要がある。

普通にSQLを使おうとするとこんな感じになる。
1. 投稿内容が含まれるテーブルから`投稿内容`と`ユーザID`を取得するSQLを実行する。

```sql
SELECT * FROM 投稿内容テーブル;
```
2. ユーザデータのテーブルにアクセスして`ユーザID`から`ユーザ名`
を取得するSQLを実行する。

```sql
SELECT ユーザ名　FROM ユーザテーブル WHERE ユーザテーブル.ユーザID = 1;
SELECT ユーザ名　FROM ユーザテーブル WHERE ユーザテーブル.ユーザID = 2;
SELECT ユーザ名　FROM ユーザテーブル WHERE ユーザテーブル.ユーザID = 1;
```

すると，投稿数ユーザ数が増えると2のSQL文を実行する量がとてつもなく増えてしまう。これがN+1問題である。

### ではどうすればよいのか?

1. 投稿内容が含まれるテーブルから`投稿内容`とユーザIDを取得するSQLを実行する。ここまでは同じで良い。
2. プログラム等でユーザIDの一覧を作る。 --> 今回の場合は[1, 2]
3. ユーザIDの一覧を渡してまとめてユーザ名の一覧を受け取る。

```sql
SELECT ユーザ名 FROM ユーザテーブル ユーザーテーブル.ユーザID IN (1, 2);
```

> INを使うと特定の列の値が指定されたリストのいずれかに一致するかをチェックできる。つまり，今回のケースだとユーザIDが1と2のユーザ名が取得できる。

## あとがき: そもそも一つのテーブルに全部入れてしまえば解決するのでは?
ここまで読んだ勘のいい読者はそもそもテーブルを一つにまとめてしまえばこんなこと考えなくていいし，SQLの実行も一回で住むのでは?と考えたかもしれない。

なぜ，このようなテーブル構造になるのかというと，SQLには正規化という概念があり，適切にテーブルを分割することでデータの冗長性を減らし，一貫性を保ちやすくなるのである。

近年だとNOSQL等が流行っており，これを使うとテーブルの構造等をきにしなくてもなんでもぶち込むことができる。
アジャイル開発の場合は一生懸命データベースの構成を考えてもそれがいらなくなる可能性も考慮してとりあえず，NOSQLを使えば楽で早いのかなと思うが，保守のことを考えると通常のSQL(RDS)も捨てたものでは無いと思う。
